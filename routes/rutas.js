const express=require("express");const enrutadorPrincipal=express.Router();const bcrypt=require("bcrypt");const ProfileService=require("../services/profileService");function verificarAutenticacion(solicitud,respuesta,siguiente){if(solicitud.session.user){siguiente()}else{respuesta.redirect("/iniciar-sesion?error=true")}}enrutadorPrincipal.get("/",(solicitud,respuesta)=>{respuesta.render("index")});enrutadorPrincipal.get("/contacto",(solicitud,respuesta)=>{respuesta.render("contacto")});enrutadorPrincipal.get("/programa",(solicitud,respuesta)=>{respuesta.render("programa")});enrutadorPrincipal.get("/iniciar-sesion",(solicitud,respuesta)=>{const error=solicitud.query.error;const registro=solicitud.query.registro;respuesta.render("iniciar-sesion",{error:error,registro:registro})});enrutadorPrincipal.post("/iniciar-sesion",async(solicitud,respuesta)=>{const{email:email,password:password}=solicitud.body;const user=await ProfileService.encontrarUsuarioPorEmail(email);if(user&&await bcrypt.compare(password,user.password)){solicitud.session.user=user;respuesta.redirect("/dashboard")}else{respuesta.redirect("/iniciar-sesion?error=credenciales_invalidas")}});enrutadorPrincipal.get("/registro",(solicitud,respuesta)=>{const error=solicitud.query.error;respuesta.render("registro",{error:error})});enrutadorPrincipal.post("/registro",async(solicitud,respuesta)=>{const{name:name,email:email,studentId:studentId,password:password}=solicitud.body;const hashedPassword=await bcrypt.hash(password,10);try{await ProfileService.crearUsuario({name:name,email:email,studentId:studentId,password:hashedPassword});respuesta.redirect("/iniciar-sesion?registro=exitoso")}catch(error){console.error("Error en el registro:",error);respuesta.redirect("/registro?error=email_en_uso")}});enrutadorPrincipal.get("/dashboard",verificarAutenticacion,(solicitud,respuesta)=>{respuesta.render("dashboard",{user:solicitud.session.user})});enrutadorPrincipal.get("/cursos",verificarAutenticacion,(solicitud,respuesta)=>{respuesta.render("cursos",{user:solicitud.session.user})});enrutadorPrincipal.get("/calificaciones",verificarAutenticacion,(solicitud,respuesta)=>{respuesta.render("calificaciones",{user:solicitud.session.user})});enrutadorPrincipal.get("/perfil",verificarAutenticacion,(solicitud,respuesta)=>{respuesta.render("perfil",{user:solicitud.session.user})});enrutadorPrincipal.get("/logout",(solicitud,respuesta)=>{solicitud.session.destroy(err=>{if(err){console.error("Error al cerrar sesi√≥n:",err);return respuesta.redirect("/")}respuesta.redirect("/iniciar-sesion")})});module.exports=enrutadorPrincipal;