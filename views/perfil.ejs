<%- include('partials/header') %>

<div class="container-fluid mt-5 pt-5">
    <div class="row">
        <nav id="sidebar" class="col-md-3 col-lg-2 d-md-block bg-light sidebar collapse">
            <div class="position-sticky pt-3">
                <ul class="nav flex-column">
                    <li class="nav-item">
                        <a class="nav-link" href="/dashboard">
                            <i class="bi bi-house-door"></i>
                            Panel de Control
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/cursos">
                            <i class="bi bi-book"></i>
                            Cursos
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/calificaciones">
                            <i class="bi bi-journal-check"></i>
                            Calificaciones
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" aria-current="page" href="/perfil">
                            <i class="bi bi-person-circle"></i>
                            Perfil
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/logout">
                            <i class="bi bi-box-arrow-right"></i>
                            Cerrar Sesión
                        </a>
                    </li>
                </ul>
            </div>
        </nav>

        <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
            <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                <h1 class="h2">Perfil</h1>
            </div>

            <div class="row">
                <div class="col-md-8">
                    <div class="card">
                        <div class="card-body">
                            <form id="profileForm">
                                <div class="mb-3">
                                    <label for="name" class="form-label">Nombre</label>
                                    <input type="text" class="form-control" id="name" name="name" value="">
                                </div>
                                <div class="mb-3">
                                    <label for="email" class="form-label">Correo Electrónico</label>
                                    <input type="email" class="form-control" id="email" name="email" value="">
                                </div>
                                <div class="mb-3">
                                    <label for="studentId" class="form-label">ID de Estudiante</label>
                                    <input type="text" class="form-control" id="studentId" name="studentId" value="" readonly>
                                </div>
                                <button type="submit" class="btn btn-primary-custom">Actualizar Perfil</button>
                                <div id="profileFeedback" class="mt-3"></div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>

        </main>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const profileForm = document.getElementById('profileForm');
        const nameInput = document.getElementById('name');
        const emailInput = document.getElementById('email');
        const studentIdInput = document.getElementById('studentId');
        const profileFeedback = document.getElementById('profileFeedback');

        // Function to fetch profile data
        const fetchProfile = async () => {
            try {
                const response = await fetch('/api/profile');
                if (!response.ok) {
                    throw new Error('Error al cargar el perfil');
                }
                const profile = await response.json();
                nameInput.value = profile.name;
                emailInput.value = profile.email;
                studentIdInput.value = profile.studentId;
            } catch (error) {
                profileFeedback.innerHTML = `<div class="alert alert-danger">${error.message}</div>`;
            }
        };

        // Function to handle form submission
        profileForm.addEventListener('submit', async (event) => {
            event.preventDefault();

            const updatedData = {
                name: nameInput.value,
                email: emailInput.value,
                studentId: studentIdInput.value,
            };

            try {
                const response = await fetch('/api/profile', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(updatedData),
                });

                if (!response.ok) {
                    throw new Error('Error al actualizar el perfil');
                }

                const result = await response.json();
                profileFeedback.innerHTML = `<div class="alert alert-success">Perfil actualizado correctamente.</div>`;
                // Optionally, update form fields with the returned data if needed
                nameInput.value = result.name;
                emailInput.value = result.email;
                studentIdInput.value = result.studentId;

            } catch (error) {
                profileFeedback.innerHTML = `<div class="alert alert-danger">${error.message}</div>`;
            }
        });

        // Fetch profile data on page load
        fetchProfile();
    });
</script>

<%- include('partials/footer') %>